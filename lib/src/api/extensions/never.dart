part of '../../cont.dart';

/// Extension for running continuations that never produce a value.
///
/// This extension provides specialized methods for [Cont]<[E], [Never]> where only
/// termination is expected, simplifying the API by removing the unused value callback.
extension ContNeverExtension<E> on Cont<E, Never> {
  /// Executes the continuation expecting only termination.
  ///
  /// This is a convenience method for [Cont]<[E], [Never]> that executes the
  /// continuation with only a termination handler, since a value callback
  /// would never be called for a [Cont]<[E], [Never]>.
  ///
  /// All callbacks are optional and default to no-op, allowing callers to
  /// subscribe only to the channels they care about.
  ///
  /// - [env]: The environment value to provide as context during execution.
  /// - [isCancelled]: Function polled by the runtime to check whether
  ///   execution should be cooperatively cancelled. Defaults to always
  ///   returning `false` (never cancelled).
  /// - [onPanic]: Callback invoked when a fatal, unrecoverable error occurs.
  ///   Defaults to re-throwing inside a microtask.
  /// - [onElse]: Callback invoked when the continuation terminates with
  ///   errors. Defaults to ignoring the errors.
  ///
  /// Example:
  /// ```dart
  /// final cont = Cont.terminate<MyEnv, Never>([ContError(Exception('Failed'), StackTrace.current)]);
  /// cont.trap(myEnv, onElse: (errors) {
  ///   print('Terminated with ${errors.length} error(s)');
  /// });
  /// ```
  ContCancelToken trap(
    E env, {
    bool Function() isCancelled = _false,
    void Function(ContError error) onPanic = _panic,
    void Function(List<ContError> errors) onElse = _ignore,
  }) {
    final ContCancelToken cancelToken = ContCancelToken._();
    _run(
      ContRuntime._(env, cancelToken.isCancelled, onPanic),
      ContObserver._(onElse, (_) {}),
    );

    return cancelToken;
  }

  /// Converts a continuation that never produces a value to any desired type.
  ///
  /// The absurd method implements the principle of "ex falso quodlibet" (from
  /// falsehood, anything follows) from type theory. It allows converting a
  /// `Cont<E, Never>` to `Cont<E, A>` for any type `A`.
  ///
  /// Since `Never` is an uninhabited type with no possible values, the mapping
  /// function `(Never never) => never` can never actually execute. However, the
  /// type system accepts this transformation as valid, enabling type-safe
  /// conversion from a continuation that cannot produce a value to one with
  /// any desired value type.
  ///
  /// This is particularly useful when:
  /// - Working with continuations that run forever (e.g., from [forever])
  /// - Matching types with other continuations in composition
  /// - Converting terminating-only continuations to typed continuations
  ///
  /// Type parameters:
  /// - [A]: The desired value type for the resulting continuation
  ///
  /// Returns a continuation with the same environment type but a different
  /// value type parameter.
  ///
  /// Example:
  /// ```dart
  /// // A server that runs forever has type Cont<Env, Never>
  /// final server = handleRequests().forever();
  ///
  /// // Convert to Cont<Env, String> to match other continuation types
  /// final serverAsString = server.absurd<String>();
  /// ```
  Cont<E, A> absurd<A>() {
    return thenMap<A>((
      Never // gonna give you up
      never, // gonna let you down
    ) {
      return never; // gonna run around and desert you
    });
  }

  /*
  ..:..............:::------:::::::::----:-:::.::-----:::--::----::::::::----------:::::::::..........
................::::-------::::::::---::::::--=-=+*++*##**++=--:::::::----------:::::::::....:......
..............::::::::--:--:::::::::---::.:-*##########*******=::::::::----------::::..:...........:
..........::::::..::::::::-----------------=+*###############**+--------------------:..:............
.......:::::::....::::::...:----:::..:-:-=+***######%%#######***+------:::--------------:...........
..:::::::::::.....::::::.::--::::::::-===++**##################*+-------::------::-------:..........
:::::::::::::.....::::::::::::.......::-=++*++++=====+=----==*##*=:.------------::------------:.....
:::.....:::::.....::::::::............:=*#*+=++====----------=+**=:::-----------:::.:----------::...
:::........:::....:::::::::.:........:-*#*++++++====--=-------=**=::::::--------::::-----::::----::.
:..........::::...::::::::...........:-***+++++++===--==-----==**=::::::--------::::---:::::::----::
:........:::::::::::::::::...........:-+*++++*+++**+=-=+++=====*+-:::::---------::----::::::::::---:
::::.....:::...::::::::::.........::..:+++++++**+++++=-=+*+====+:......:-----------:----:::::::::--:
::::::..::.......:::::::::..........:====-=++====++++=--=======-....:::::---------:::----::::-----::
:....::::........::::::::::::.......-=++=-=+++==+++++=--------==::..:.::---------::::::----------:::
:......::...... ..::::::::--::.......-+====++++++++**++=-----==-:::.:-----------::::..::---------:::
:.......::.......:::::::..:---:.....:-==+++++++++++==-=-----===:::::-----:-------:.:.:.:--:..:::----
:........:........::::::..::------------:-=++++++++===--------:::------::::------:.:...:-:.....:----
:........:.......::::::::-------------.::-=++++++++===--==--------------::-------:.....:-:.......:--
:::......::......:::::::::-::...:.:---:---==+++++=====--===----:::.:-------------:.....-:......::---
::::......:......:::::::::::.:....::--:::-++++++++===-====-:---::::::::----------:::..:-:.....::::--
:::::.....::.....::::::::...:...::-------=+++++++++++=====-----::..::.::---------:::.:--:.....::::::
..::::...:::::::.:::::::....:::----------=+++++++++=======-::-----::::::::-------:::----:....::::...
.:::::::::....::::::::::...:.::----::::--=+++++++=========-==::----::::::::--------------:.:--::....
------::::......::::::---::::---------:-=+++++++++========:+##=:----::::::----------:::---:---::....
--------::.:....::::-------:--==+++=-=::---=+++++========--*####*=---::::---------::::::----------:.
::------:.......:---------=++*#####+=++++*++++++++===++=:-+###%%%%%#*+-::---------:::::::-----------
.---------:::..:-----==+*##%%%%%%%#*=++++++====++++++=-::=##%%%%%%%%%%%##*=::-----::::::-------:....
.--::-----:....:=++**##%%%%%%%%%%%%#=+*++++=+==++++--::::=#%%%%%%%%%%%%%%%%%##=::::::::---------::::
:--:..:----:..:=##%%%%%%%%%%%%%%%%%#=+***++-=+++=--:::::-*%%%%%%%%%#*+#%%%%%%%%%#*-::::-----:---::::
:-::.::-----::-*%%%%%%#%%%%%%%%%%%%#=+***++===---::::::=#%%%%%%%%#*+++===+#%%%%%%%%#*:-----:::---:::
:::....:----::+#%%%%%%%%%%%%%%%%%%%%******++*+++++=-::=%%%%%%%%%%*+++++++===*%%%%%%%#*------::---:::
:::.:..:------*#%%%%%%%%%%%%%%%%%%%%****++=***++===++*%%%%%%%%%%#+++++======+#%%%%%%##+---:::::---::
::...::--::--=#%%%%%%%%%%%%%%%%%%%%%%%*==+**+=--=++*##%%%%%%%%%%#++++=======+%%%%%%%%#+:--::::::--::
-:..:----:::-=#%%%%%%%%%%%%%%%%%%%%%%%#======++**#***#%%%%%%%%%%%#**+======+*%%%%%%%%%*-----::::---:
-:::-------:+*#%%%%%%%%%%%%%%%%%%%%%%%+-==+*###**+==+%%%%%%%%%%%%%%*++=====+#%%%%%%%%#*------:::---:
::----:::--=*#%%%%%%%%%%%%%%%%%%%%%%%%+-==***+=--=+*%%%%%%%%%%%%%%%*++=====+#%%%%%%%%#*-------::---:
----:.....:+#%%%%%%%%%%%%%%%%%%%%%%%%%+--==--=+*#%%%%%%%%%%%%%%%%@%#*++====+#%%%%%%%%%*::::---------
---::::.:::+%%%%%%%%%%%%%%%%%%%%%%%%%%*==+##%%%%#+=+%%%%%%%%%%%%%@@%**+====+#%%%%%%%%%*:::::::------
-:.......:-+%%%%%%%%%%%%%%%%%%%%%%%%%%%**##*+=====+#%%%%%%%%%%%%@@@@%**++===+%%%%%%%%%#-::::::------
:........:-*%%%%%%%%%%%@%%%%%%%%%%%%%%%**+===+*#%%%%%%%%%%%%%%%@@@@@@@%%%%%%#%%%%%%%%%#=:::::::::---
:........:=*%%%%%%%%%%%@%%%%%%%%%%%%%%%**####%%#***%%%%%%%%%%@@@@@@@@@@@%####%%%%%%%%%#=::::--:-----
-::...:::=+#%%%%%@@@@@@@@@@%%%%@%%%%%%%**##*+++++*#%%%%%%%%@@@@@@@@@@@@@%%%%%%%%##%%%%%*-::::::::---
---:::::=++#%%%%%@@@@@@@@@@@%%@@%%%%%%%***+++**##%%@%@%%%@@@@@@@@@@@@@@@@@@@@%%%%#%%%%%%#=-:::------
----::-*###%%%%%@@@@@@@@@@@@%#+++++++++**#########%%%%%%%@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%*-::-------
:----+%%%%%@@@@@@@@@@%@@@@@#**+++++*+++**####**++*%@%%@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%*=------=-
::--=##%%%##%%%%%%%%*##**#*++++++++++++*********#%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%*----==
:::-*%%%%%%#*###%%%#**##%%#****++++++++*****###%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%*=-==
--:-*%%%###%%%%%@%#*%%%%%%#****++*++++***%%%%%%#*#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%@%%%@%%%%%*==
:::--*%#%%%%%%%@%%#%%%%%%%#****++*++++%****+++**#%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%@%%%%%#==
::-===#%%%%%%%%%%%%%@@@%%%##*******#%@@#****###%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%@@%%%%+==
:--===#%%%%%%%%%%%%%%%%@@@@@%%%@@@@@@@@##%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%@%%%+===
-=----*%%%%%%%%%%%###%%%%%%%@@@@@@@@@@@#********#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%*-===
----:--=*#%%%%%%%%%#%%@@@@@@@@@@@@@@@@%#*####%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%#=====
::::....:::--=========-================--==------=============================================::::::

   */
}
